(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5368],{85368:function(e){e.exports=function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=11)}([function(e,t,n){"use strict";function i(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}Object.defineProperty(t,"__esModule",{value:!0}),i(n(12)),i(n(8))},function(e,t,n){"use strict";e.exports=function(e){var t,n={};if(!(e instanceof Object)||Array.isArray(e))throw new Error("keyMirror(...): Argument must be an object.");for(t in e)e.hasOwnProperty(t)&&(n[t]=t);return n}},function(e,t,n){"use strict";var i,r="object"==typeof Reflect?Reflect:null,o=r&&"function"==typeof r.apply?r.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};i=r&&"function"==typeof r.ownKeys?r.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var a=Number.isNaN||function(e){return e!=e};function s(){s.init.call(this)}e.exports=s,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._eventsCount=0,s.prototype._maxListeners=void 0;var l=10;function u(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function c(e,t,n,i){var r,o,a,s;if("function"!=typeof n)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n);if(void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),o=e._events),a=o[t]),void 0===a)a=o[t]=n,++e._eventsCount;else if("function"==typeof a?a=o[t]=i?[n,a]:[a,n]:i?a.unshift(n):a.push(n),(r=u(e))>0&&a.length>r&&!a.warned){a.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=a.length,s=l,console&&console.warn&&console.warn(s)}return e}function p(){for(var e=[],t=0;t<arguments.length;t++)e.push(arguments[t]);this.fired||(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,o(this.listener,this.target,e))}function h(e,t,n){var i={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},r=p.bind(i);return r.listener=n,i.wrapFn=r,r}function d(e,t,n){var i=e._events;if(void 0===i)return[];var r=i[t];return void 0===r?[]:"function"==typeof r?n?[r.listener||r]:[r]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(r):_(r,r.length)}function f(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function _(e,t){for(var n=new Array(t),i=0;i<t;++i)n[i]=e[i];return n}Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return l},set:function(e){if("number"!=typeof e||e<0||a(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");l=e}}),s.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},s.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||a(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return u(this)},s.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var i="error"===e,r=this._events;if(void 0!==r)i=i&&void 0===r.error;else if(!i)return!1;if(i){var a;if(t.length>0&&(a=t[0]),a instanceof Error)throw a;var s=new Error("Unhandled error."+(a?" ("+a.message+")":""));throw s.context=a,s}var l=r[e];if(void 0===l)return!1;if("function"==typeof l)o(l,this,t);else{var u=l.length,c=_(l,u);for(n=0;n<u;++n)o(c[n],this,t)}return!0},s.prototype.addListener=function(e,t){return c(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return c(this,e,t,!0)},s.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.on(e,h(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);return this.prependListener(e,h(this,e,t)),this},s.prototype.removeListener=function(e,t){var n,i,r,o,a;if("function"!=typeof t)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof t);if(void 0===(i=this._events))return this;if(void 0===(n=i[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(r=-1,o=n.length-1;o>=0;o--)if(n[o]===t||n[o].listener===t){a=n[o].listener,r=o;break}if(r<0)return this;0===r?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,r),1===n.length&&(i[e]=n[0]),void 0!==i.removeListener&&this.emit("removeListener",e,a||t)}return this},s.prototype.off=s.prototype.removeListener,s.prototype.removeAllListeners=function(e){var t,n,i;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var r,o=Object.keys(n);for(i=0;i<o.length;++i)"removeListener"!==(r=o[i])&&this.removeAllListeners(r);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},s.prototype.listeners=function(e){return d(this,e,!0)},s.prototype.rawListeners=function(e){return d(this,e,!1)},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):f.call(e,t)},s.prototype.listenerCount=f,s.prototype.eventNames=function(){return this._eventsCount>0?i(this._events):[]}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=n(4),r=n(13),o=function(){function e(e,t){this.event=e,this.eid=r.v4(),this.ts_ms=Date.now(),this._tracker=new i.Tracker,this._globalBPO=t}return Object.defineProperty(e.prototype,"tracker",{get:function(){return this._tracker},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"global",{get:function(){return this._globalBPO},enumerable:!0,configurable:!0}),e.getAttributeTypeMap=function(){return e.attributeTypeMap},e.attributeTypeMap=[{name:"eid",baseName:"eid",type:"string"},{name:"ts_ms",baseName:"ts_ms",type:"number"},{name:"event",baseName:"event",type:"Event"},{name:"global",baseName:"global",type:"Event"},{name:"tracker",baseName:"tracker",type:"Tracker"}],e}();t.Envelope=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(){this.name="bigpicture-client-ts",this.version="1.1.3"}return e.getAttributeTypeMap=function(){return e.attributeTypeMap},e.attributeTypeMap=[{name:"name",baseName:"name",type:"string"},{name:"version",baseName:"version",type:"string"}],e}();t.Tracker=i},function(e,t,n){var i=n(6),r=n(7);e.exports=function(e,t,n){var o=t&&n||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var a=(e=e||{}).random||(e.rng||i)();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t)for(var s=0;s<16;++s)t[o+s]=a[s];return t||r(a)}},function(e,t){var n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(n){var i=new Uint8Array(16);e.exports=function(){return n(i),i}}else{var r=new Array(16);e.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),r[t]=e>>>((3&t)<<3)&255;return r}}},function(e,t){for(var n=[],i=0;i<256;++i)n[i]=(i+256).toString(16).substr(1);e.exports=function(e,t){var i=t||0,r=n;return[r[e[i++]],r[e[i++]],r[e[i++]],r[e[i++]],"-",r[e[i++]],r[e[i++]],"-",r[e[i++]],r[e[i++]],"-",r[e[i++]],r[e[i++]],"-",r[e[i++]],r[e[i++]],r[e[i++]],r[e[i++]],r[e[i++]],r[e[i++]]].join("")}},function(e,t,n){"use strict";function i(e){for(var n in e)t.hasOwnProperty(n)||(t[n]=e[n])}Object.defineProperty(t,"__esModule",{value:!0}),i(n(3)),i(n(9)),i(n(4));var r=n(3),o=n(9),a=n(4),s=["string","boolean","double","integer","long","float","number","any"],l={},u={Envelope:r.Envelope,Event:o.Event,Tracker:a.Tracker},c=function(){function e(){}return e.findCorrectType=function(e,t){if(null==e)return t;if(-1!==s.indexOf(t.toLowerCase()))return t;if("Date"===t)return t;if(l[t])return t;if(!u[t])return t;var n=u[t].discriminator;if(null==n)return t;if(e[n]){var i=e[n];return u[i]?i:t}return t},e.serialize=function(t,n){if(null==t)return t;if(-1!==s.indexOf(n.toLowerCase()))return t;if(0===n.lastIndexOf("Array<",0)){var i=n.replace("Array<","");i=i.substring(0,i.length-1);var r=[];for(var o in t){var a=t[o];r.push(e.serialize(a,i))}return r}if("Date"===n)return t.toISOString();if(l[n])return t;if(!u[n])return t;n=this.findCorrectType(t,n);var c=u[n].getAttributeTypeMap(),p={};for(var o in c){var h=c[o];p[h.baseName]=e.serialize(t[h.name],h.type)}return p},e.deserialize=function(t,n){if(n=e.findCorrectType(t,n),null==t)return t;if(-1!==s.indexOf(n.toLowerCase()))return t;if(0===n.lastIndexOf("Array<",0)){var i=n.replace("Array<","");i=i.substring(0,i.length-1);var r=[];for(var o in t){var a=t[o];r.push(e.deserialize(a,i))}return r}if("Date"===n)return new Date(t);if(l[n])return t;if(!u[n])return t;var c=new u[n],p=u[n].getAttributeTypeMap();for(var o in p){var h=p[o];c[h.name]=e.deserialize(t[h.baseName],h.type)}return c},e}();t.ObjectSerializer=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i=function(){function e(e,t,n){this.name=e,this.ts_ms=Date.now(),this.version=t,this.fields=n}return e.getAttributeTypeMap=function(){return e.attributeTypeMap},e.attributeTypeMap=[{name:"name",baseName:"name",type:"string"},{name:"ts_ms",baseName:"ts_ms",type:"number"},{name:"version",baseName:"version",type:"number"},{name:"fields",baseName:"fields",type:"object"}],e}();t.Event=i},function(e){e.exports=JSON.parse('{"name":"vimeo-uploader","version":"2.25.14","log_to_console":false,"tomdawg":{"url":"https://devu.cloud.vimeo.com"},"lighthouse":{"url":"https://lighthouse.vimeocdn.com"},"leatherback":{"url":"https://leatherback.vimeo-prod.appspot.com"},"user":{"id":1,"account_type":"basic","is_mod":true,"use_leatherback":false}}')},function(e,t,n){e.exports=n(15)},function(e,t,n){"use strict";var i=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(r,o){function a(e){try{l(i.next(e))}catch(e){o(e)}}function s(e){try{l(i.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}l((i=i.apply(e,t||[])).next())}))},r=this&&this.__generator||function(e,t){var n,i,r,o,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,i=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(r=(r=a.trys).length>0&&r[r.length-1])&&(6===o[0]||2===o[0])){a=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){a.label=o[1];break}if(6===o[0]&&a.label<r[1]){a.label=r[1],r=o;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(o);break}r[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(e){o=[6,e],i=0}finally{n=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}};Object.defineProperty(t,"__esModule",{value:!0});var o,a=n(3),s=n(8);!function(e){e.FRESNEL_PROD="https://fresnel-events.vimeocdn.com",e.FRESNEL_DEV="https://fresnel-event-staging.vimeows.com"}(o=t.Service||(t.Service={}));var l=function(e,t){void 0===t&&(t=null),this.service=e,this.globalBPO=t};t.Configuration=l;var u=function(){function e(){}return e.configure=function(t){e.conf=t},e.sendEvent=function(e){return i(this,void 0,void 0,(function(){var t,n;return r(this,(function(i){switch(i.label){case 0:if(null==e)throw new Error("Required parameter event was null or undefined when calling sendEvent.");return t={method:"POST",headers:{"Content-Type":"application/json","User-Agent":navigator.userAgent,Origin:location.origin,Referer:document.referrer},body:JSON.stringify(s.ObjectSerializer.serialize([new a.Envelope(e,this.conf.globalBPO)],"Array<Envelope>"))},n=this.conf.service+"/add/"+encodeURIComponent(String(e.name)),[4,fetch(n,t)];case 1:return i.sent(),[2]}}))}))},e.conf=new l(o.FRESNEL_PROD),e}();t.BigPictureClient=u},function(e,t,n){var i=n(14),r=n(5),o=r;o.v1=i,o.v4=r,e.exports=o},function(e,t,n){var i,r,o=n(6),a=n(7),s=0,l=0;e.exports=function(e,t,n){var u=t&&n||0,c=t||[],p=(e=e||{}).node||i,h=void 0!==e.clockseq?e.clockseq:r;if(null==p||null==h){var d=o();null==p&&(p=i=[1|d[0],d[1],d[2],d[3],d[4],d[5]]),null==h&&(h=r=16383&(d[6]<<8|d[7]))}var f=void 0!==e.msecs?e.msecs:(new Date).getTime(),_=void 0!==e.nsecs?e.nsecs:l+1,v=f-s+(_-l)/1e4;if(v<0&&void 0===e.clockseq&&(h=h+1&16383),(v<0||f>s)&&void 0===e.nsecs&&(_=0),_>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");s=f,l=_,r=h;var g=(1e4*(268435455&(f+=122192928e5))+_)%4294967296;c[u++]=g>>>24&255,c[u++]=g>>>16&255,c[u++]=g>>>8&255,c[u++]=255&g;var y=f/4294967296*1e4&268435455;c[u++]=y>>>8&255,c[u++]=255&y,c[u++]=y>>>24&15|16,c[u++]=y>>>16&255,c[u++]=h>>>8|128,c[u++]=255&h;for(var b=0;b<6;++b)c[u+b]=p[b];return t||a(c)}},function(e,t,n){"use strict";n.r(t);var i=n(10),r=n(1),o=n.n(r),a=o()({STARTING:null,VALIDATING:null,ATTACHING:null,UPLOADING:null,RESUMING:null,REROUTING:null}),s=o()({QUEUED:null,PAUSED:null,CANCELED:null,COMPLETED:null,FAILED:null,CANCELING:null,REMOVED:null}),l=Object.assign({},a,s),u=o()({PROGRESS:null,STATE_CHANGE:null,FILE_SIZE_CHANGED:null}),c={CLIP:"clip",CLIP_REPLACE:"replace_clip",API_PULL_CLIP:"api_pull_clip",API_PULL_CLIP_REPLACE:"api_pull_clip_replace",DRM_CLIP:"drm_clip",DRM_CLIP_REPLACE:"drm_clip_replace"},p=[c.API_PULL_CLIP,c.API_PULL_CLIP_REPLACE],h=c,d={UPLOAD_SERVICE_SITE:"UPLOAD_SERVICE_SITE",UPLOAD_SERVICE_LEATHERBACK:"UPLOAD_SERVICE_LEATHERBACK",UPLOAD_SERVICE_API:"UPLOAD_SERVICE_API"},f=n(5),_=n.n(f),v=n(2),g=n.n(v);function y(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function b(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var m=function e(t,n){var i,r=[];for(var o in t)if(t.hasOwnProperty(o)){var a=t[o];switch(n&&(o="".concat(n,"[").concat(o,"]")),Object.prototype.toString.call(a)){case"[object Object]":i=e(a,o);break;case"[object Array]":var s={};if(0===a.length)a=null;else{for(var l=0,u=a.length;l<u;l++)s[l]=a[l];i=e(s,o)}break;default:i="".concat(o,"=").concat(encodeURIComponent(a))}null!==a&&r.push(i)}return r.join("&")},E=function(){if("undefined"!=typeof window&&!("Blob"in window))return!1;var e;try{e=new Blob}catch(t){if(window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,!window.BlobBuilder)return!1;"TypeError"===t.name&&window.BlobBuilder&&(e=(new window.BlobBuilder).getBlob())}return"slice"in e?"slice":"mozSlice"in e?"mozSlice":"webkitSlice"in e&&"webkitSlice"},w=function(e){return isNaN(e)?e:parseInt(e,10)},R=function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return function(){for(var r=arguments.length,o=new Array(r),a=0;a<r;a++)o[a]=arguments[a];return new Promise((function(r,a){t.apply(void 0,o).then(r).catch((function(s){var l=i+1;if(l>n)return a(s);var u=1e3*Math.pow(2,l)+Math.round(1e3*Math.random()),c=e(t,n,l);return setTimeout((function(){c.apply(void 0,o).then(r).catch(a)}),u)}))}))}},O=function(e,t){return t=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?y(n,!0).forEach((function(t){b(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):y(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},{method:"GET",headers:{},body:null,withCredentials:!1,successCode:200},{},t),new Promise((function(n,i){var r=new XMLHttpRequest;r.open(t.method,e),Object.keys(t.headers).forEach((function(e){r.setRequestHeader(e,t.headers[e])})),r.addEventListener("load",(function(e){return e.target.status!==t.successCode?i(e):n(e)})),r.addEventListener("error",i),r.addEventListener("timeout",i),r.send(t.body)}))},A=R(O,4);function P(e){return(P="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function L(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var k=["assert","clear","count","debug","dir","dirxml","error","group","groupCollapsed","groupEnd","info","log","profile","profileEnd","table","time","timeEnd","trace","warn"],S={log:"DEFAULT",info:"INFO",debug:"NOTICE",warn:"WARNING",error:"ERROR"},C=function(){for(var e={},t=k.length,n=0;n<t;n++)e[k[n]]=function(){};return e},I=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.limit=k.length,this._logs=[],this._log_strings=[],this._console="object"===("undefined"==typeof console?"undefined":P(console))?console:C(),this.config=t,this.output_to_console=t.log_to_console||t.user.is_mod,this.labels={version:t.version,user_id:"".concat(t.user.id),user_account_type:t.user.account_type,user_agent:window?window.navigator.userAgent:""}}var t,n,i;return t=e,(n=[{key:"_normalizeLog",value:function(){var e=arguments.length,t="";if(0===e)return null;for(var n=0;n<e;n++){var i=n<0||arguments.length<=n?void 0:arguments[n],r=P(i);t+="string"===r||"number"===r||"boolean"===r?i:"[Object object]",n<e-1&&(t+=", ")}return t}},{key:"_addLogEntry",value:function(e){for(var t=this.labels,n=arguments.length,i=new Array(n>1?n-1:0),r=1;r<n;r++)i[r-1]=arguments[r];for(var o=0;o<i.length;o++){var a={severity:S[e],labels:t,timestamp:(new Date).toISOString()},s=i[o],l=P(s);"object"!==l||Array.isArray(l)?a.textPayload=s:a.jsonPayload=s,this._logs.push(a)}var u=this._normalizeLog.apply(this,i);this._log_strings.push(u),this.output_to_console&&this._console[e](u)}},{key:"addLabel",value:function(e,t){e&&t?(this.labels["".concat(e)]="".concat(t),this._logs=this._logs.map((function(n){return n.labels["".concat(e)]="".concat(t),n}))):this._addLogEntry("warn","Incorrect logger label: {".concat(e,": ").concat(t,"}"))}},{key:"log",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];0!==t.length&&this._addLogEntry.apply(this,["log"].concat(t))}},{key:"info",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];0!==t.length&&this._addLogEntry.apply(this,["info"].concat(t))}},{key:"debug",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];0!==t.length&&this._addLogEntry.apply(this,["debug"].concat(t))}},{key:"warn",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];0!==t.length&&this._addLogEntry.apply(this,["warn"].concat(t))}},{key:"error",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];0!==t.length&&this._addLogEntry.apply(this,["error"].concat(t))}},{key:"save",value:function(){var e=this,t=this.config,n={entries:this._logs},i={method:"POST",headers:{Authorization:"Bearer ".concat(t.leatherback.token),"Content-Type":"application/json"},body:JSON.stringify(n)};return A("".concat(t.leatherback.url,"/log"),i).then((function(){return e.clear()}))}},{key:"clear",value:function(){this._logs=[],this._log_strings=[]}},{key:"logs",get:function(){return this._log_strings}}])&&L(t.prototype,n),i&&L(t,i),e}();function T(e,t){window.newrelic&&window.newrelic.noticeError(e,t)}var U=o()({NO_MACHINE_ID:null,VERIFICATION_FAILED:null,DNS_ERROR:null,COMPLETE_CALL_FAILED:null,RETRY_FAILED:null,ATTACH_FAILED:null,PROGRESS_CALL_ERROR:null,METADATA_CALL_ERROR:null,PROGRESS_STATE_MISMATCH:null,VIDEO_FILE_INVALID:null,QUOTA_EXCEEDED:null,NETWORK_ERROR:null,VIDEO_FILE_REMOVED:null,VIDEO_FILE_SIZE_CHANGED:null,FILE_TOO_SMALL:null,INVALID_DROPBOX_URL:null,INVALID_UPLOAD_ENDPOINT:null,RANGE_FAILED:null,PULL_FAILED:null,VALIDATOR_CALL_ERROR:null,LIGHTHOUSE_LOAD_ERROR:null,LIGHTHOUSE_RACE_ERROR:null,RANGE_RESUME_FAILED:null,TOTAL_CAP_EXCEEDED:null,RANGE_RESUME_HEADERS_MISSING:null,RANGE_HEADERS_MISSING:null}),j=[U.VIDEO_FILE_INVALID,U.VIDEO_FILE_SIZE_CHANGED,U.VIDEO_FILE_REMOVED],D=[U.VIDEO_FILE_REMOVED,U.VIDEO_FILE_SIZE_CHANGED],N=2204,F={NO_MACHINE_ID:901,VERIFICATION_FAILED:902,DNS_ERROR:903,COMPLETE_CALL_FAILED:904,RETRY_FAILED:905,ATTACH_FAILED:906,PROGRESS_CALL_ERROR:907,METADATA_CALL_ERROR:908,PROGRESS_STATE_MISMATCH:909,VIDEO_FILE_INVALID:910,QUOTA_EXCEEDED:911,NETWORK_ERROR:912,VIDEO_FILE_REMOVED:913,VIDEO_FILE_SIZE_CHANGED:914,FILE_TOO_SMALL:915,INVALID_DROPBOX_URL:916,INVALID_UPLOAD_ENDPOINT:917,RANGE_FAILED:918,PULL_FAILED:919,VALIDATOR_CALL_ERROR:920,LIGHTHOUSE_LOAD_ERROR:921,LIGHTHOUSE_RACE_ERROR:922,RANGE_RESUME_FAILED:923,TOTAL_CAP_EXCEEDED:924};function x(e){return(x="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function G(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function M(e,t){return!t||"object"!==x(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function H(e){return(H=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function z(e,t){return(z=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var V=function(e){function t(e,n,i,r,o){var a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(a=M(this,H(t).call(this))).upload_type=n,a.file=r,a.initial_size=r.size,a.id=a._generateId(),a.state=l.QUEUED,a.bytes_uploaded=0,a.api_app=i,a.config=e,a.folder_id=r.folder_id,a.logger=new I(e),a.logger.addLabel("upload_type",n),a.logger.addLabel("api_app",i),o&&a.logger.addLabel("clip_id",o),a.error=null,a.uploader=null,a.clip_id=o||null,a.clip_url=null,a.attempt_id=null,a.fastest_region=null,a.ip=null,a.start_timestamp=0,a.end_timestamp=0,a.pause_duration=0,a.slice_method=E(),a._bindMethods(),a}var n,i,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&z(e,t)}(t,e),n=t,(i=[{key:"_onUploaderProgress",value:function(e){var t=this.file;(0,this._hasFileSizeChanged)();var n=e.loaded;this.bytes_uploaded=n;var i=this.speed_mbps,r=this.eta;return this.emit(u.PROGRESS,{bytes_uploaded:n,total_bytes:t.size,eta:r,speed_mbps:i})}},{key:"_onUploaderComplete",value:function(){var e=this.file,t=this.config,n=this.upload_type,i=this.logger;return this.end_timestamp=(new Date).getTime(),this.bytes_uploaded=this.file.size,this._onUploaderProgress({loaded:e.size,total:e.size}),this.state=l.COMPLETED,this.removeAllListeners(),t.service!==d.UPLOAD_SERVICE_API?null:p.indexOf(n)>=0?i.save():t.send_learning_data_to_leartherback||t.send_learning_data_to_leatherback?(this._saveLearningData(),i.save()):i.save()}},{key:"_onUploaderFail",value:function(e){var t=this.logger;return e&&"object"===x(e)&&"target"in e&&e.target instanceof XMLHttpRequest?(t.warn("[BaseClient] _onUploaderFail: Status: ".concat(e.target.status," ").concat(e.target.statusText," - Response text: ").concat(e.target.responseText)),T(e,{message:"[BaseClient] _onUploaderFail",status:e.target.status,statusText:e.target.statusText,responseText:e.target.responseText,level:"warning"})):(t.error("[BaseClient] _onUploaderFail: ".concat(e.toString())),T(e,{message:"[BaseClient] _onUploaderFail",responseText:e.toString(),level:"error"})),e.stack&&(t.error(e.stack),T(e.stack,{message:"[BaseClient] _onUploaderFail Error Stack",level:"error"})),this.end_timestamp=(new Date).getTime(),this.error=e,this.state=l.FAILED,this.removeAllListeners(),j.indexOf(e)>-1?null:t.save()}},{key:"_onValidateReject",value:function(e){var t=this.logger,n=this.file;return e===U.VALIDATOR_CALL_ERROR?(t.warn("[BaseClient] _onValidateReject: VALIDATOR_CALL_ERROR, passing through"),T(e,{message:"[BaseClient] _onValidateReject: VALIDATOR_CALL_ERROR, passing through",level:"warning"}),Promise.resolve(n.type)):e&&"object"===x(e)&&"target"in e&&e.target instanceof XMLHttpRequest?(t.warn("[BaseClient] _onValidateReject: ".concat(e.target.status," - ").concat(e.target.responseText)),T(e,{message:"[BaseClient] _onValidateReject",status:e.target.status,responseText:e.target.responseText,level:"warning"}),Promise.resolve(n.type)):(t.warn("[BaseClient] _onValidateReject: ".concat(e.toString())),T(e,{message:"[BaseClient] _onValidateReject",level:"warning"}),Promise.reject(e))}},{key:"_onUploaderStateChange",value:function(){var e=this.uploader;switch(e.state){case l.COMPLETED:this._onUploaderComplete();break;case l.FAILED:this._onUploaderFail(e.error);break;default:this.state=e.state}}},{key:"_bindMethods",value:function(){this._onUploaderProgress=this._onUploaderProgress.bind(this),this._onUploaderComplete=this._onUploaderComplete.bind(this),this._onUploaderFail=this._onUploaderFail.bind(this),this._onValidateReject=this._onValidateReject.bind(this),this._onUploaderStateChange=this._onUploaderStateChange.bind(this),this._saveLearningData=this._saveLearningData.bind(this),this._hasFileSizeChanged=this._hasFileSizeChanged.bind(this),this.start=this.start.bind(this),this.pause=this.pause.bind(this),this.cancel=this.cancel.bind(this),this.resume=this.resume.bind(this)}},{key:"_generateId",value:function(){return _()()}},{key:"_saveLearningData",value:function(){var e=this.chunk_size,t=this.config,n=this.duration,i=this.file,r=this.id,o=this.fastest_region,a=this.speed_mbps,s=this.uid,l=this.uploaders,u=this.ip,c={file_uid:s||"".concat(t.service,"_").concat(r),chunk_size:e||i.size,parallel_requests:l?l.length:1,user_agent:window?window.navigator.userAgent:"",region:o.Region,upload_duration:n,upload_speed_mbps:a,file_size:i.size,ip_address:u},p={method:"POST",headers:{Authorization:"Bearer ".concat(t.leatherback.token),"Content-Type":"application/json"},body:JSON.stringify(c)};return A("".concat(t.leatherback.url,"/learning"),p).catch(console.warn)}},{key:"_hasFileSizeChanged",value:function(){var e=this.file,t=this.initial_size;if(e.size!==t){var n=0===e.size?U.VIDEO_FILE_REMOVED:U.VIDEO_FILE_SIZE_CHANGED;this.emit(u.FILE_SIZE_CHANGED,n)}}},{key:"start",value:function(){this.state=l.STARTING}},{key:"pause",value:function(){var e=this.logger,t=this.state;t===l.UPLOADING?(this.pause_start=(new Date).getTime(),this.state=l.PAUSED):e.warn("Can only pause while uploading (".concat(t,")"))}},{key:"resume",value:function(){var e=this.logger,t=this.state;t===l.PAUSED?(this.pause_duration+=(new Date).getTime()-this.pause_start,this.state=l.RESUMING):e.warn("Can only resume while paused (".concat(t,")"))}},{key:"fail",value:function(e){console.warn("[BaseClient.fail] Should only be called by subclass")}},{key:"cancel",value:function(){var e=this;this.state=l.CANCELING,setTimeout((function(){e.state=l.CANCELED,e.removeAllListeners()}),100)}},{key:"state",get:function(){return this._state},set:function(e){if(void 0!==e&&this._state!==e){if(-1===Object.keys(l).indexOf(e))throw new Error("Invalid state set for Upload: ".concat(e));var t=this._state===l.RESUMING,n=this._state===l.REROUTING;this._state=e,this._hasFileSizeChanged(),this.emit(u.STATE_CHANGE,{state:e,is_resume:t,upload:this}),e!==l.UPLOADING||t||n||(this.start_timestamp=(new Date).getTime())}}},{key:"inactive",get:function(){return this._state===l.CANCELED||this._state===l.COMPLETED||this._state===l.FAILED}},{key:"active",get:function(){return this._state===l.STARTING||this._state===l.VALIDATING||this._state===l.ATTACHING||this._state===l.UPLOADING||this._state===l.RESUMING||this._state===l.REROUTING}},{key:"speed_mbps",get:function(){var e=this.bytes_uploaded,t=this.duration;if(0===t)return 0;var n=8*e;return Math.round(n/1024/1024/t)}},{key:"duration",get:function(){var e=this.start_timestamp,t=this.pause_duration,n=this.end_timestamp,i=e+t,r=n>0?n:(new Date).getTime();return Math.round((r-i)/1e3)}},{key:"eta",get:function(){var e=this.bytes_uploaded,t=this.duration,n=this.file;if(0===e||e===n.size)return 0;var i=n.size-e,r=e/t;return Math.round(i/r)}}])&&G(n.prototype,i),r&&G(n,r),t}(g.a);function B(e){return(B="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function q(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function W(e,t){return!t||"object"!==B(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function X(e){return(X=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function J(e,t){return(J=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var K=function(e){function t(e,n,i){var r,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:window.console;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),r=W(this,X(t).call(this)),!e)throw new Error("BaseUploader needs a config");if(!n)throw new Error("BaseUploader needs an endpoint");if(!i)throw new Error("BaseUploader needs a file");return r.config=e,r.endpoint=n,r.file=i,r.logger=o,r.APP_ID=3,r.backoff_count=0,r.backoff_timeout=null,r.bytes_uploaded=0,r.started_on=new Date,r.last_progress_dispatch=null,r.slice_method=E(),r._bindMethods(),r}var n,i,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&J(e,t)}(t,e),n=t,(i=[{key:"_onUploadProgress",value:function(e){var t=this.last_progress_dispatch,n=window.performance.now();this.bytes_uploaded=e.loaded,n-(t=t||0)<200||(this.last_progress_dispatch=n,this.emit(u.PROGRESS,{loaded:e.loaded}))}},{key:"_bindMethods",value:function(){this._complete=this._complete.bind(this),this._onUploadProgress=this._onUploadProgress.bind(this)}},{key:"_complete",value:function(e){this.bytes_uploaded=this.file.size,this.state=l.COMPLETED,this.removeAllListeners()}},{key:"upload",value:function(){}},{key:"pause",value:function(){}},{key:"resume",value:function(){this.state=l.RESUMING}},{key:"cancel",value:function(){this.removeAllListeners()}},{key:"fail",value:function(e){this.logger.error("[BaseUploader] fail: ".concat(e.toString())),T(e,{message:"[BaseUploader] fail",level:"error"}),this.error=e,this.state=l.FAILED,this.removeAllListeners()}},{key:"state",get:function(){return this._state},set:function(e){if(void 0!==e&&this._state!==e){if(-1===Object.keys(l).indexOf(e))throw new Error("Invalid state set for Upload: ".concat(e));this._state=e,this.emit(u.STATE_CHANGE,{state:e,uploader:this})}}}])&&q(n.prototype,i),r&&q(n,r),t}(g.a);function Z(e){return(Z="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Q(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],i=!0,r=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(e){r=!0,o=e}finally{try{i||null==s.return||s.return()}finally{if(r)throw o}}return n}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function Y(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function $(e,t){return!t||"object"!==Z(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function ee(e,t,n){return(ee="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=te(e)););return e}(e,t);if(i){var r=Object.getOwnPropertyDescriptor(i,t);return r.get?r.get.call(n):r.value}})(e,t,n||e)}function te(e){return(te=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ne(e,t){return(ne=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ie=function(e){function t(e,n,i,r){var o,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:window.console,s=arguments.length>5?arguments[5]:void 0;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(o=$(this,te(t).call(this,e,n,i,a))).mime_type=r,o.resumed_bytes=0;var l=n.match(/v1\/b\/([a-z,-]*)\//);l&&l.length>0&&(o.bucket=l.pop()),void 0===o.bucket&&(l=n.match("com/([a-z,-]*)/"))&&l.length>0&&(o.bucket=l.pop());var u=n.match(/upload_id=([^&]*)/);return u&&u.length>0&&(o.upload_id=u.pop()),o.jwtToken=void 0===s?e.leatherback.token:s,o}var n,i,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ne(e,t)}(t,e),n=t,(i=[{key:"_bindMethods",value:function(){this._abortRequests=this._abortRequests.bind(this),this._getRange=this._getRange.bind(this),this._getRangeServerSide=this._getRangeServerSide.bind(this),this._makeUploadRequest=this._makeUploadRequest.bind(this),this._onRequestReject=this._onRequestReject.bind(this),this._onRequestResolve=this._onRequestResolve.bind(this),this._parseHeadersForRange=this._parseHeadersForRange.bind(this),this._parseRangeHeader=this._parseRangeHeader.bind(this),this._handleCompleteUpload=this._handleCompleteUpload.bind(this),this._handleIncompleteUpload=this._handleIncompleteUpload.bind(this),ee(te(t.prototype),"_bindMethods",this).call(this)}},{key:"_abortRequests",value:function(){var e=this.logger,t=this._xhr,n=this.backoff_timeout;t?(t.abort(),clearTimeout(n),this.backoff_count=0):e.info("[GCSUploader] no xhr to cancel: ".concat(t))}},{key:"_parseRangeHeader",value:function(e){var t=this.logger;if("string"!=typeof e)return t.warn("[GCSUploader] _parseRangeHeader empty header: ".concat(e)),!1;var n=Q(e.split("-"),2),i=n[0],r=n[1];t.info("[GCSUploader] _parseRangeHeader: ".concat(i," -> ").concat(r));var o=parseInt(r,10);return isNaN(o)?(t.warn("[GCSUploader] _parseRangeHeader: finish isn't a number: ".concat(o)),!1):o}},{key:"_parseHeadersForRange",value:function(){var e=this.logger,t=this._xhr,n=this._parseRangeHeader;e.info("[GCSUploader] ".concat(t.status,": ").concat(t.statusText));try{var i=t.getAllResponseHeaders();if(/^Range:/im.test(i)){var r=t.getResponseHeader("Range");return e.info(i),n(r)}e.info("[GCSUploader] _parseHeadersForRange: No range header"),e.info(i)}catch(t){e.info("[GCSUploader] _parseHeadersForRange getAllResponseHeaders: ".concat(t))}try{return n(t.getResponseHeader("Range"))}catch(t){e.info("[GCSUploader] _parseHeadersForRange getResponseHeader: ".concat(t))}try{var o=t.getAllResponseHeaders();e.info("[GCSUploader] _parseHeadersForRange No range header: ".concat(o))}catch(t){e.info("[GCSUploader] _parseHeadersForRange final fail: ".concat(t))}return!1}},{key:"_onRequestReject",value:function(e){var t=this.logger,n=this._xhr;return e&&"object"===Z(e)&&"target"in e&&e.target instanceof XMLHttpRequest?(t.warn("[GCSUploader] _onUploaderFail: XHR Failed"),t.warn("[GCSUploader] _onUploaderFail: Status: ".concat(e.target.status," ").concat(e.target.statusText," - Response text: ").concat(e.target.responseText)),T(e,{message:"[GCSUploader] _onUploaderFail",status:e.target.status,statusText:e.target.statusText,level:"warning",responseText:e.target.responseText})):(t.error("[GCSUploader] _onUploaderFail: ~XHR error - ".concat(e)),T(e,{message:"[GCSUploader] _onUploaderFail",level:"error"})),e instanceof Error?this.fail(e):-1===D.indexOf(e)&&n?"status"in n&&404===n.status?this.fail(U.INVALID_UPLOAD_ENDPOINT):this._retryWithBackoff():this.fail(e)}},{key:"_onUploadProgress",value:function(e){var n=this.resumed_bytes+e.loaded;return ee(te(t.prototype),"_onUploadProgress",this).call(this,{loaded:n})}},{key:"_makeRequest",value:function(e,t,n){var i=this,r=this.endpoint,o=this._onUploadProgress,a=this._xhr;return a instanceof XMLHttpRequest&&(2===a.readyState||3===a.readyState)&&a.abort(),new Promise((function(a,s){i.error&&s(i.error),i._xhr=new XMLHttpRequest,i._xhr.open("PUT",r,!0),i._xhr.setRequestHeader("Content-Type",t),i._xhr.setRequestHeader("Content-Range",e),i._xhr.setRequestHeader("X-GUploader-No-308","yes"),i._xhr.addEventListener("load",a),i._xhr.addEventListener("error",s),i._xhr.addEventListener("timeout",s),void 0!==n&&i._xhr.upload.addEventListener("progress",o),i._xhr.send(n)}))}},{key:"_getRange",value:function(){var e=this.file;this.logger.info("[GCSUploader] _getRange");var t="bytes */".concat(e.size);return this._makeRequest(t,"application/octet-stream")}},{key:"_makeUploadRequest",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=this.logger,n=this.file,i=this.slice_method,r=this.mime_type,o=this.config.max_request_chunk_size;this.state=l.UPLOADING;var a=n.size,s=n;if(!1===i?(e=0,this.bytes_uploaded=0):(a=Math.min(e+o,n.size),s=n[i](e,a)),0===a)return t.info("User has probably deleted the file"),Promise.reject(U.VIDEO_FILE_REMOVED);a-=1,t.info("[GCSUploader] _makeUploadRequest: ".concat(e," -> ").concat(a));var u="bytes ".concat(e,"-").concat(a,"/").concat(n.size);return this._makeRequest(u,r,s)}},{key:"_getRangeServerSide",value:function(){var e=this,t=this.upload_id,n=this.attempt_id,i=this.logger,r=this.config,o=this.bucket,a="/upload/_range?attempt_id=".concat(n);return r.service!==d.UPLOAD_SERVICE_LEATHERBACK&&r.service!==d.UPLOAD_SERVICE_API||(a="".concat(r.leatherback.url,"/attempt/range?bucket=").concat(o,"&upload_id=").concat(t)),i.info("[GCSUploader] _getRangeServerSide"),new Promise((function(t,n){e._xhr=new XMLHttpRequest,e._xhr.open("GET",a),r.service===d.UPLOAD_SERVICE_SITE&&e._xhr.setRequestHeader("X-Requested-With","XMLHttpRequest"),r.service!==d.UPLOAD_SERVICE_LEATHERBACK&&r.service!==d.UPLOAD_SERVICE_API||e._xhr.setRequestHeader("Authorization","Bearer ".concat(e.jwtToken)),e._xhr.addEventListener("load",t),e._xhr.addEventListener("error",n),e._xhr.addEventListener("timeout",n),e._xhr.send()}))}},{key:"_onRequestResolve",value:function(){var e=this.logger,t=this._xhr,n=this._handleCompleteUpload,i=this._handleIncompleteUpload,r="308"===t.getResponseHeader("X-HTTP-Status-Code-Override")||308===t.status;return e.info("[GCSUploader] _onRequestResolve: ".concat(t.status)),e.info("[GCSUploader] _onRequestResolve: Incomplete Upload? ".concat(r)),r?i():n()}},{key:"_handleCompleteUpload",value:function(){var e=this.logger,t=this._xhr,n=this._complete;return 200!==t.status?(e.warn("[GCSUploader] Bad GCS response: ".concat(t.status)),this.state===l.RESUMING?Promise.reject(U.RANGE_RESUME_FAILED):Promise.reject(U.RANGE_FAILED)):(e.info("[GCSUploader] Upload complete: ".concat(t.status)),n())}},{key:"_handleIncompleteUpload",value:function(){var e=this._makeUploadRequest,t=this._parseHeadersForRange,n=this._onRequestResolve,i=this._onRequestReject,r=t();return!1===r?this.state===l.RESUMING?Promise.reject(U.RANGE_RESUME_HEADERS_MISSING):Promise.reject(U.RANGE_HEADERS_MISSING):(this.backoff_count=0,this.bytes_uploaded=r,this.resumed_bytes=r,e(r+1).then(n).catch(i))}},{key:"_retryWithBackoff",value:function(){var e=this.file,t=this.logger,n=this._getRange,i=this._getRangeServerSide,r=this._makeUploadRequest,o=this._onRequestResolve,a=this._onRequestReject;this.backoff_count++;var s=e.size<=10485760?2:4,u=e.size<=10485760?1:2,c=e.size<=10485760?3:6;if(this.backoff_count>c)return t.info("[GCSUploader] Exceeded retries, failing upload attempt"),this.fail(U.RETRY_FAILED);var p=n;this.backoff_count>u&&this.backoff_count<=s&&(t.info("[GCSUploader] Exceeded client range retries, trying server side"),p=i),this.backoff_count>s&&(t.info("[GCSUploader] Exceeded range retries, restarting upload"),this.state=l.REROUTING,p=r);var h=1e3*Math.pow(2,this.backoff_count)+Math.round(1e3*Math.random());return t.info("[GCSUploader] retry #".concat(this.backoff_count," after ").concat(h,"ms")),this.backoff_timeout=setTimeout((function(){p().then(o).catch(a)}),h),this.backoff_timeout}},{key:"upload",value:function(){var e=this._onRequestResolve,n=this._onRequestReject;ee(te(t.prototype),"upload",this).call(this),this._makeUploadRequest().then(e).catch(n)}},{key:"pause",value:function(){this._abortRequests(),ee(te(t.prototype),"pause",this).call(this)}},{key:"resume",value:function(){var e=this._onRequestResolve,n=this._onRequestReject;ee(te(t.prototype),"resume",this).call(this),this._getRange().then(e).catch(n)}},{key:"fail",value:function(e){ee(te(t.prototype),"fail",this).call(this,e),this._abortRequests()}},{key:"cancel",value:function(){this._abortRequests(),ee(te(t.prototype),"cancel",this).call(this)}}])&&Y(n.prototype,i),r&&Y(n,r),t}(K);function re(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var oe=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:window.console;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),"string"!=typeof t)throw new Error("Invalid endpoint passed to VideoValidator");this.endpoint=t,this.chunk_size=512,this.logger=n,this._onResolve=this._onResolve.bind(this)}var t,n,i;return t=e,(n=[{key:"_onResolve",value:function(e){var t,n=this.logger,i=e.target;if(200!==i.status)return n.info("[VideoValidator] _onResolve status: ".concat(i.status)),n.info("[VideoValidator] _onResolve response: ".concat(i.responseText)),Promise.reject(U.VALIDATOR_CALL_ERROR);try{t=JSON.parse(i.responseText)}catch(e){return n.info("[VideoValidator] _onResolve: Failed to parse xhr.responseText - ".concat(i.responseText)),Promise.reject(e)}return n.addLabel("file_type",t.ContentType),t.Blacklisted?Promise.reject(U.VIDEO_FILE_INVALID):Promise.resolve(t.ContentType)}},{key:"validateFile",value:function(e){var t=this.endpoint,n=this.slice_method,i=this.chunk_size,r=this._onResolve;if(!1===n)return Promise.resolve(e.type);var o={method:"PUT",body:e[n](0,i)};return R(O,2)(t,o).then(r)}},{key:"validateUrl",value:function(e){var t=this.endpoint,n=this._onResolve;return R(O,2)("".concat(t,"?url=").concat(e)).then(n)}},{key:"slice_method",get:function(){if("undefined"!=typeof window&&!("Blob"in window))return!1;if(this._slice_method)return this._slice_method;var e;try{e=new Blob}catch(t){if(window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,!window.BlobBuilder)return this._slice_method=!1,this._slice_method;"TypeError"===t.name&&window.BlobBuilder&&(e=(new window.BlobBuilder).getBlob())}return"slice"in e?this._slice_method="slice":"mozSlice"in e?this._slice_method="mozSlice":"webkitSlice"in e&&(this._slice_method="webkitSlice"),this._slice_method},set:function(e){this._slice_method=e}}])&&re(t.prototype,n),i&&re(t,i),e}();function ae(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function se(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ae(n,!0).forEach((function(t){le(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ae(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function le(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ue(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ce=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:window.console;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw new Error("[VimeoApp] constructor requires a config");this.config=t,this.logger=n,this._parseResponse=this._parseResponse.bind(this),this._parseToken=this._parseToken.bind(this)}var t,n,i;return t=e,(n=[{key:"_parseResponse",value:function(e){var t=this.logger,n=e.target,i=n.status,r=n.responseText;if(200!==i)return t.info("[VimeoApp] _parseResponse ".concat(i,": ").concat(r)),Promise.reject(e);try{var o=JSON.parse(r);return Promise.resolve(o)}catch(e){return Promise.reject(e)}}},{key:"_parseToken",value:function(e){var t=this.logger,n=e.target,i=n.status,r=n.responseText;if(200!==i)return t.info("[VimeoApp] _parseResponse ".concat(i,": ").concat(r)),Promise.reject(e);try{var o=e.target.getResponseHeader("Authorization");return Promise.resolve(o)}catch(e){return t.info("[VimeoApp] _parseResponse ".concat(i,": ").concat(r)),Promise.reject(e)}}},{key:"_post",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,i=this.config,r={method:"POST",headers:{Accept:"application/json","Content-Type":"application/x-www-form-urlencoded; charset=UTF-8","X-Requested-With":"XMLHttpRequest"},body:m(se({},t,{token:i.xsrft})),withCredentials:!0};return null!==n&&(r.headers.Authorization="Bearer ".concat(n)),A(e,r)}},{key:"attach",value:function(e,t,n,i,r,o,a,s){return this._post("/upload/_attach",{file_name:e,file_size:t,type:n,region:i,api_app:r,content_type:o,clip_id:a,folder_id:s}).then(this._parseResponse)}},{key:"pause",value:function(e,t,n){return this._post("/upload/_pause",{attempt_id:e,upload_type:t,signature:n}).then(this._parseResponse)}},{key:"resume",value:function(e,t,n){return this._post("/upload/_resume",{attempt_id:e,upload_type:t,signature:n}).then(this._parseResponse)}},{key:"cancel",value:function(e,t,n){return this._post("/upload/_cancel",{attempt_id:e,upload_type:t,signature:n}).then(this._parseResponse)}},{key:"complete",value:function(e,t,n,i,r,o){return this._post("/upload/_complete",{attempt_id:e,video_file_id:t,upload_type:n,signature:o,make_private:!0===i,file_extension:r&&r.length<=4?r:""}).then(this._parseResponse)}},{key:"fail",value:function(e,t,n){return this._post("/upload/_fail",{attempt_id:e,type:t,signature:n}).then(this._parseResponse)}},{key:"saveError",value:function(e,t){return this._post("/upload/_save_error",{attempt_id:e,error_code:t}).then(this._parseResponse)}},{key:"getToken",value:function(e){return this._post("/upload/_verify",{},e).then(this._parseToken)}}])&&ue(t.prototype,n),i&&ue(t,i),e}();function pe(e){return function(e){if(Array.isArray(e))return e}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function he(e){return(he="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function de(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function fe(e,t){return!t||"object"!==he(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function _e(e,t,n){return(_e="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=ve(e)););return e}(e,t);if(i){var r=Object.getOwnPropertyDescriptor(i,t);return r.get?r.get.call(n):r.value}})(e,t,n||e)}function ve(e){return(ve=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function ge(e,t){return(ge=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ye=function(e){function t(e,n,i,r,o){var a;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),a=fe(this,ve(t).call(this,e,n,i,r,o)),!e.tomdawg)throw new Error("[SiteClient] tomdawg data not in the config");if(n===h.CLIP_REPLACE&&!o)throw new Error("[SiteClient] Clip replacement upload must provide a clip_id");return a.server_url=e.tomdawg.url,a.clip_id=o,a.vimeo_app=new ce(e,a.logger),a._setFileSizeChangeListener(),a}var n,i,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&ge(e,t)}(t,e),n=t,(i=[{key:"_onUploaderComplete",value:function(){var e=this,n=this.file,i=this.upload_type,r=this.attempt_id,o=this.video_file_id,a=this.vimeo_app,s=this.logger,l=this.signature,u=function(e){var t;return e.match(/\.([^.]*)$/i)&&(t=e.split(".").pop().toLowerCase()),t}(n.name);a.complete(r,o,i,n,u,l).then((function(n){return _e(ve(t.prototype),"_onUploaderComplete",e).call(e)})).catch((function(t){return s.warn("[SiteClient] _onUploaderComplete failed",t.toString()),e._onUploaderFail(U.COMPLETE_CALL_FAILED)}))}},{key:"_onUploaderFail",value:function(e){var n=this.attempt_id;if(_e(ve(t.prototype),"_onUploaderFail",this).call(this,e),n){var i=this.vimeo_app,r=this.upload_type,o=this.signature;e in F&&n&&i.saveError(n,F[e]),i.fail(n,r,o)}}},{key:"_onAttachReject",value:function(e){var t=this.logger;return e&&"object"===he(e)&&"target"in e&&e.target instanceof XMLHttpRequest?(t.warn("[SiteClient] _onUploaderFail: ".concat(e.target.status," - ").concat(e.target.responseText)),T(e,{message:"[SiteClient] _onUploaderFail",status:e.target.status,responseText:e.target.responseText,level:"warning"})):(t.error("[SiteClient] _onUploaderFail: ".concat(e.toString())),T(e,{message:"[SiteClient] _onUploaderFail",level:"error"})),Promise.reject(U.ATTACH_FAILED)}},{key:"_bindMethods",value:function(){this._onAttachReject=this._onAttachReject.bind(this),this._validate=this._validate.bind(this),this._createAttempt=this._createAttempt.bind(this),this._beginUploading=this._beginUploading.bind(this),this._setFileSizeChangeListener=this._setFileSizeChangeListener.bind(this),_e(ve(t.prototype),"_bindMethods",this).call(this)}},{key:"_validate",value:function(e){var t=pe(e),n=t[0];t.slice(1),this.fastest_region=n;var i=this.id,r=this.file,o=this.server_url,a=this.logger,s=this._onValidateReject;return this.state=l.VALIDATING,new oe("".concat(o,"/probe/").concat(i),a).validateFile(r).catch(s)}},{key:"_createAttempt",value:function(e){var t=this.file,n=this.fastest_region,i=this.vimeo_app,r=this.upload_type,o=this.api_app,a=this.clip_id,s=this.folder_id,u=this._onAttachReject;return this.state=l.ATTACHING,i.attach(t.name,t.size,r,n.Region,o,e,a,s).catch(u)}},{key:"_beginUploading",value:function(e){var t=this.logger,n=this.file,i=this.config,r=this._onUploaderProgress,o=this._onUploaderStateChange,a=e.clip_id,s=e.video_file_id,l=e.attempt_id,c=e.upload_id,p=e.upload_endpoint,h=e.clip_url,d=e.signature;this.clip_id=a,this.clip_url=h,this.attempt_id=l,this.uid=c,this.video_file_id=s,this.signature=d,t.addLabel("clip_id",a),t.addLabel("attempt_id",l),t.addLabel("video_file_id",s),this.uploader=new ie(i,p,n,n.type,t),this.uploader.attempt_id=l,this.uploader.on(u.PROGRESS,r),this.uploader.on(u.STATE_CHANGE,o),this.uploader.upload()}},{key:"_setFileSizeChangeListener",value:function(){var e=this;this.on(u.FILE_SIZE_CHANGED,(function(t){e.fail(t)}))}},{key:"start",value:function(){_e(ve(t.prototype),"start",this).call(this);var e=this.config.lighthouse,n=this._validate,i=this._createAttempt,r=this._beginUploading,o=this._onUploaderFail;e.getFastestRegion().then(n).then(i).then(r).catch(o)}},{key:"pause",value:function(){_e(ve(t.prototype),"pause",this).call(this);var e=this.vimeo_app,n=this.attempt_id,i=this.upload_type,r=this.signature,o=this.logger,a=this.uploader;a&&a.pause(),e.pause(n,i,r).catch((function(e){o.warn("[SiteClient] pause ".concat(e.toString()))}))}},{key:"resume",value:function(){_e(ve(t.prototype),"resume",this).call(this);var e=this.vimeo_app,n=this.attempt_id,i=this.upload_type,r=this.signature,o=this.logger,a=this.uploader;a&&a.resume(),e.resume(n,i,r).catch((function(e){o.warn("[SiteClient] resume ".concat(e.toString()))}))}},{key:"fail",value:function(e){this.uploader.fail(e)}},{key:"cancel",value:function(){_e(ve(t.prototype),"cancel",this).call(this);var e=this.vimeo_app,n=this.attempt_id,i=this.upload_type,r=this.signature,o=this.logger,a=this.uploader;a&&a.cancel(),e.cancel(n,i,r).catch((function(e){o.warn("[SiteClient] cancel ".concat(e.toString()))}))}}])&&de(n.prototype,i),r&&de(n,r),t}(V);function be(e){return(be="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function me(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Ee(e,t){return!t||"object"!==be(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function we(e,t,n){return(we="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Re(e)););return e}(e,t);if(i){var r=Object.getOwnPropertyDescriptor(i,t);return r.get?r.get.call(n):r.value}})(e,t,n||e)}function Re(e){return(Re=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Oe(e,t){return(Oe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ae=function(e){function t(e,n,i,r){var o,a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:window.console;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),o=Ee(this,Re(t).call(this,e,n,i,a)),!r)throw new Error("PullUploader needs an api_token");return o.token=r,o._xhr=null,o}var n,i,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Oe(e,t)}(t,e),n=t,(i=[{key:"_onRequestReject",value:function(e){var t=this.logger,n=e.target;if(t.warn("[PullUpload] _onRequestReject: ".concat(n.status,": ").concat(n.statusText)),n.status>=500)return this.fail(U.DNS_ERROR);var i=JSON.parse(n.responseText);return"error_code"in i&&i.error_code===N?this.fail(U.VIDEO_FILE_INVALID):"error"in i?this.fail(i.error):this.fail(U.PULL_FAILED)}},{key:"_onRequestResolve",value:function(e){var t=this.logger,n=e.target,i=JSON.parse(n.responseText);if(200!==n.status||!i.uri)return t.info("[PullUpload] PULL_API_FAILED: ".concat(n.status,": ").concat(n.statusText," - ").concat(i.error||n.responseText)),Promise.reject(e);var r=i.uri;return this.clip_id=parseInt(r.split("/").pop(),10),this.clip_url="/".concat(this.clip_id),t.addLabel("clip_id",this.clip_id),this._complete()}},{key:"_bindMethods",value:function(){this._abortRequests=this._abortRequests.bind(this),this._dispatchProgressEvent=this._dispatchProgressEvent.bind(this),this._endFakeProgress=this._endFakeProgress.bind(this),this._makeUploadRequest=this._makeUploadRequest.bind(this),this._onRequestReject=this._onRequestReject.bind(this),this._onRequestResolve=this._onRequestResolve.bind(this),this._startFakeProgress=this._startFakeProgress.bind(this),we(Re(t.prototype),"_bindMethods",this).call(this)}},{key:"_dispatchProgressEvent",value:function(){var e=this.bytes_uploaded,t=this.file,n=this._onUploadProgress,i=(new Date).getTime()-this.start,r=t.size-e;this.bytes_uploaded=function(e,t,n,i){return n*Math.sin(e/(100*i)*(Math.PI/2))+t}(i,e,r,2e4),n({loaded:e})}},{key:"_startFakeProgress",value:function(){this.start=(new Date).getTime(),this._progressInterval=setInterval(this._dispatchProgressEvent.bind(this),250)}},{key:"_endFakeProgress",value:function(){clearTimeout(this._progressInterval)}},{key:"_makeUploadRequest",value:function(){var e=this,t=this.token,n=this.file,i=this.endpoint;this.state=l.UPLOADING,this._startFakeProgress();var r={type:"pull",link:n.link,size:n.size,current_user:n.target_user_id,folder_id:n.folder_id};n.headers&&(r.headers=n.headers),n.thumbnailLink&&(r.picture_link=n.thumbnailLink),"string"==typeof n.name&&(r.name=n.name);var o={Accept:"application/vnd.vimeo.video;version=3.2",Authorization:"Bearer ".concat(t)};return new Promise((function(t,n){e._xhr=new XMLHttpRequest,e._xhr.open("POST",i),e._xhr.setRequestHeader("Content-Type","application/json"),e._xhr.setRequestHeader("Accept",o.Accept),e._xhr.setRequestHeader("Authorization",o.Authorization),e._xhr.addEventListener("load",t),e._xhr.addEventListener("error",n),e._xhr.addEventListener("timeout",n),e._xhr.send(JSON.stringify(r))}))}},{key:"_abortRequests",value:function(){var e=this.logger;this._xhr?(this._endFakeProgress(),this._xhr.abort()):e.warn("[PullUploader] no xhr to cancel: ".concat(this._xhr))}},{key:"upload",value:function(){we(Re(t.prototype),"upload",this).call(this),this._makeUploadRequest().then(this._onRequestResolve.bind(this)).catch(this._onRequestReject.bind(this))}},{key:"fail",value:function(e){we(Re(t.prototype),"fail",this).call(this,e),this._abortRequests()}},{key:"cancel",value:function(){this.removeAllListeners()}}])&&me(n.prototype,i),r&&me(n,r),t}(K);function Pe(e){return(Pe="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Le(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function ke(e,t){return!t||"object"!==Pe(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Se(e,t,n){return(Se="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ce(e)););return e}(e,t);if(i){var r=Object.getOwnPropertyDescriptor(i,t);return r.get?r.get.call(n):r.value}})(e,t,n||e)}function Ce(e){return(Ce=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Ie(e,t){return(Ie=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Te=function(e){function t(e,n,i,r,o){var a;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),a=ke(this,Ce(t).call(this,e,n,i,r,o)),!r.link)throw new Error("ApiClient file object needs a link property");if(!r.size)throw new Error("ApiClient file object needs a size property");var s=e.api,l=s.url,u=s.tokens;if(!l)throw new Error("[ApiClient] Incorrect config format for vime api");if(!u[i])throw new Error("Token for ApiApp #".concat(i," must be in config.api.tokens"));return a.api_token=u[i],a.endpoint="//".concat(l,"/users/").concat(r.target_user_id,"/videos"),a.vimeo_app=new ce(e,a.logger),a}var n,i,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Ie(e,t)}(t,e),n=t,(i=[{key:"_onUploaderComplete",value:function(){var e=this.uploader,n=e.clip_id,i=e.clip_url;this.clip_id=n,this.clip_url=i,Se(Ce(t.prototype),"_onUploaderComplete",this).call(this)}},{key:"_onUploaderFail",value:function(e){var n=this.logger,i=this.attempt_id,r=this.vimeo_app;n.warn("[ApiClient] _onUploaderFail ".concat(e.toString())),T(e,{message:"[ApiClient] _onUploaderFail",level:"warning"}),Se(Ce(t.prototype),"_onUploaderFail",this).call(this,e),i&&(j.indexOf(e)>-1||e in F&&r.saveError(i,F[e]))}},{key:"_bindMethods",value:function(){this._validate=this._validate.bind(this),this._beginUploading=this._beginUploading.bind(this),this._validateResponse=this._validateResponse.bind(this),Se(Ce(t.prototype),"_bindMethods",this).call(this)}},{key:"_validate",value:function(){var e=this,t=this.logger,n=this.file;return this.state=l.VALIDATING,t.addLabel("file_link",n.link),new Promise((function(t,i){e._xhr=new XMLHttpRequest,e._xhr.open("GET",n.link),"object"===Pe(n.headers)&&Object.keys(n.headers).forEach((function(t){e._xhr.setRequestHeader(t,n.headers[t])})),e._xhr.onreadystatechange=function(){if(e._xhr.readyState===XMLHttpRequest.HEADERS_RECEIVED||e._xhr.readyState===XMLHttpRequest.READYSTATE_LOADED){var n={status:e._xhr.status,content_type:e._xhr.getResponseHeader("Content-Type")};setTimeout((function(){e._xhr.abort()}),0),t(n)}},e._xhr.addEventListener("error",(function(){i(U.INVALID_UPLOAD_ENDPOINT)})),e._xhr.addEventListener("timeout",(function(){i(U.INVALID_UPLOAD_ENDPOINT)})),e._xhr.send()}))}},{key:"_beginUploading",value:function(){var e=this.file,t=this.logger,n=this.endpoint,i=this.api_token,r=this.config,o=this._onUploaderProgress,a=this._onUploaderStateChange;this.uploader=new Ae(r,n,e,i,t),this.uploader.on(u.PROGRESS,o),this.uploader.on(u.STATE_CHANGE,a),this.uploader.upload()}},{key:"_validateResponse",value:function(e){return this.logger.addLabel("file_type",e.content_type),429===e.status?Promise.reject(U.INVALID_DROPBOX_URL):200!==e.status?Promise.reject(U.VIDEO_FILE_INVALID):Promise.resolve()}},{key:"start",value:function(){Se(Ce(t.prototype),"start",this).call(this);var e=this._validate,n=this._validateResponse,i=this._beginUploading,r=this._onUploaderFail;e().then(n).then(i).catch(r)}},{key:"pause",value:function(){this._xhr.abort(),Se(Ce(t.prototype),"pause",this).call(this)}},{key:"resume",value:function(){Se(Ce(t.prototype),"resume",this).call(this),this.start()}},{key:"fail",value:function(e){this.uploader.fail(e)}},{key:"cancel",value:function(){this._xhr.abort(),Se(Ce(t.prototype),"cancel",this).call(this)}}])&&Le(n.prototype,i),r&&Le(n,r),t}(V),Ue={UPLOAD_FROM_CLIENT:"upload_from_client",UPLOADER_COMPLETE:"uploader_complete",UPLOAD_FAILURE:"upload_failure"},je=n(0);function De(e){return(De="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ne(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],i=!0,r=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(e){r=!0,o=e}finally{try{i||null==s.return||s.return()}finally{if(r)throw o}}return n}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function Fe(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function xe(e,t){return!t||"object"!==De(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ge(e,t,n){return(Ge="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Me(e)););return e}(e,t);if(i){var r=Object.getOwnPropertyDescriptor(i,t);return r.get?r.get.call(n):r.value}})(e,t,n||e)}function Me(e){return(Me=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function He(e,t){return(He=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var ze=function(e){function t(e,n,i,r,o,a){var s;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),s=xe(this,Me(t).call(this,e,n,i,r,o)),!e.leatherback)throw new Error("[LeatherbackClient] leatherback data not in the config");if(n===h.CLIP_REPLACE&&!o)throw new Error("[LeatherbackClient] Clip replacement upload must provide a clip_id");return s.site_config=a,s.uploaders=[],s.chunk_size=e.default_parallel_chunk_size,s.clip_id=o||null,s.endpoint_count=null,s._setFileSizeChangeListener(),s.vimeo_app=new ce(e,s.logger),s}var n,i,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&He(e,t)}(t,e),n=t,(i=[{key:"_bindMethods",value:function(){this._create=this._create.bind(this),this._createAndStartUploader=this._createAndStartUploader.bind(this),this._start=this._start.bind(this),this._update=this._update.bind(this),this._validate=this._validate.bind(this),this._setFileSizeChangeListener=this._setFileSizeChangeListener.bind(this),this._startUploader=this._startUploader.bind(this),this._getEndpoints=this._getEndpoints.bind(this),this._getNewToken=this._getNewToken.bind(this),this._createAndStartUploaderWithEndpoints=this._createAndStartUploaderWithEndpoints.bind(this),Ge(Me(t.prototype),"_bindMethods",this).call(this)}},{key:"_validate",value:function(e){var t=Ne(e,2),n=t[0],i=t[1],r=this.id,o=this.file,a=this.config,s=this.logger,u=this._onValidateReject;return this.fastest_region=n,this.ip=i,this.state=l.VALIDATING,new oe("".concat(a.tomdawg.url,"/probe/").concat(r),s).validateFile(o).catch(u)}},{key:"_create",value:function(e){var t=this.config,n=this.upload_type,i=this.file,r=this.fastest_region,o=this.logger,a=this.ip,s=t.max_parallel_upload_requests;this.state=l.ATTACHING,i.size/this.chunk_size>s&&(this.chunk_size=Math.ceil(i.size/s));var u={upload_session_id:this.id,chunk_size:this.chunk_size,region:r.Region,user_region:t.user_region,clip_id:this.clip_id,browser_info:t.browser_info,vuid:t.vuid,file:{size:i.size,mime_type:i.type,name:i.name},user_ip:a,current_user:i.target_user_id,origin_user:t.origin_user.id,folder_id:i.folder_id,upload_type:n,location:window?window.location.pathname:"",app_id:this.api_app},c="".concat(t.leatherback.url,"/attempt/create"),p={method:"POST",headers:{Authorization:"Bearer ".concat(this.jwtToken),"Content-Type":"application/json"},body:JSON.stringify(u)};return o.info("[LeatherbackClient] _create: Creating file upload"),A(c,p)}},{key:"_update",value:function(e){var t=this,n=this.config,i=this.upload_type,r=this.uid,o=this.clip_id,a=this.site_config;if(!r){var s=new Error("[LeatherbackClient] _update:  missing upload id");return Promise.reject(s)}var l={clip_id:o,upload_type:i},u="".concat(n.leatherback.url,"/attempt/").concat(e,"/").concat(r),c={method:"PUT",headers:{Authorization:"Bearer ".concat(this.jwtToken),"Content-Type":"application/json"},body:JSON.stringify(l)},p=A(u,c),d={upload_id:this.uid,clip_id:this.clip_id};if(a&&i===h.CLIP_REPLACE){var f="https://".concat(a.api_url,"/videos/").concat(o,"/upload_attempts/").concat(r),_={method:"DELETE",headers:{Authorization:"jwt ".concat(a.site_jwt),"Content-Type":"application/json"},withCredentials:!0,body:JSON.stringify(d),successCode:202};A(f,_).catch((function(e){t.logger.warn("Version deletion for replacement cancellation failed",e)}))}return p}},{key:"_start",value:function(e){var t=e.target,n=t.status,i=t.responseText,r=this.logger,o=this.file;if(200!==n)return Promise.reject("".concat(n,": ").concat(i));var a=null;if("INTL"===i.substring(0,4)){var s=null,l=null;try{a=JSON.parse(i.substring(4)),r.info("[LeatherbackClient] Recieved response back from Leatherback."),r.save(),s=a.uid,l=a.signed_urls}catch(e){return Promise.reject(e)}r.addLabel("uid",s),this.uid=s,this.signed_urls=l,r.info("[LeatherbackClient] _start: Recieved uid ".concat(this.uid,"."));var u=Object.keys(l).length;this.endpoint_count=u;var c=Math.ceil(o.size/u);return this.chunk_size!==c&&(this.chunk_size=c),r.info("[LeatherbackClient] _start: Uploading ".concat(this.file.size," byte file to ").concat(u," signed_url(s)")),r.save(),Object.keys(l).forEach(this._createAndStartUploader)}try{a=JSON.parse(i)}catch(e){return Promise.reject(e)}var p=a,h=p.endpoints,d=p.uid;r.addLabel("uid",d),this.uid=d,this.uploads_completed=0,this.endpoints=h;var f=this.endpoints.length;return r.info("[LeatherbackClient] _start: Uploading ".concat(this.file.size," byte file to ").concat(f," endpoints")),h.forEach(this._createAndStartUploaderWithEndpoints)}},{key:"_onUploaderFail",value:function(e){var n=this.logger,i=this.uploaders;this.state!==l.FAILED&&(n.info("[LeatherbackClient] _onUploaderFail: Failing remaining uploads"),Ge(Me(t.prototype),"_onUploaderFail",this).call(this,e),this._update("fail"),i.forEach((function(t){t.fail(e)})))}},{key:"_createAndStartUploaderWithEndpoints",value:function(e,t){var n=this.endpoints,i=this.file,r=this.logger,o=this.slice_method,a=this.config,s=this.uid,l=this._onUploaderProgress,c=this._onUploaderStateChange,p=e.endpoint,h=e.start,d=e.end,f=e.name,_=n.length;r.info("[LeatherbackClient] _createAndStartUploaderWithEndpoints for bytes ".concat(h," to ").concat(d," (uploader ").concat(t+1,"/").concat(_,")"));var v=i[o](h,d+1);v.name=f,v.uid=s;var g=new ie(a,p,v,i.type,r,this.jwtToken);g.storage_path=f,this.uploaders.push(g),g.on(u.PROGRESS,l),g.on(u.STATE_CHANGE,c),g.upload()}},{key:"_createAndStartUploader",value:function(e){var t=this,n=this.signed_urls,i=this.file,r=this.logger,o=this.slice_method,a=this.chunk_size,s=n[e],l=e.split("/").pop(),u=Ne(l.split("_").map(w),3),c=u[0],p=u[1],h=u[2];this.total_parts=h;var d=Ne(function(e,t,n,i){var r=t*(n-1),o=r+t;return(o>e||n>=i)&&(o=e),[r,o]}(i.size,a,p,h),2),f=d[0],_=d[1];r.info("[LeatherbackClient] _createAndStartUploader for bytes ".concat(f," to ").concat(_," (uploader ").concat(p,"/").concat(h,")"));var v=i[o](f,_);v.name=l,v.uid=c,this._getEndpoints(s).then((function(n){return t._startUploader(n,v,e)})).catch((function(e){t._onUploaderFail(e)}))}},{key:"_getEndpoints",value:function(e){return new Promise((function(t,n){var i=new XMLHttpRequest;i.open("POST",e,!0),i.setRequestHeader("Content-Type","application/json; charset=UTF-8"),i.setRequestHeader("x-goog-resumable","start"),i.onload=function(){this.status>=200&&this.status<300?t(i.getResponseHeader("location")):n({status:this.status,statusText:i.statusText})},i.addEventListener("error",n),i.send()}))}},{key:"_getNewToken",value:function(){var e=this,t=this.config,n=this.vimeo_app;try{return Promise.resolve(n.getToken(t.leatherback.token)).then((function(t){return e.jwtToken=t,t}))}catch(e){return Promise.reject(e)}}},{key:"_startUploader",value:function(e,t,n){var i=this.file,r=this.logger,o=this.config,a=this.uploaders,s=this._onUploaderProgress,l=this._onUploaderStateChange,c=new ie(o,e,t,i.type,r);c.storage_path=n,a.push(c),c.on(u.PROGRESS,s),c.on(u.STATE_CHANGE,l),c.upload()}},{key:"_onUploaderProgress",value:function(e){var n=this.uploaders;this.bytes_uploaded=n.reduce((function(e,t){return e+t.bytes_uploaded}),0),Ge(Me(t.prototype),"_onUploaderProgress",this).call(this,{loaded:this.bytes_uploaded})}},{key:"_onUploaderStateChange",value:function(e){var t=this.logger,n=this.fastest_region,i=this.signed_urls,r=this._onUploaderComplete,o=this._onUploaderFail,a=this.uploaders,s=this.endpoints,u=this.config,c=this.upload_type,p=this.file,h=this.ip,d=this.uploads_completed;switch(e.state){case l.COMPLETED:var f=null;if(void 0!==s?(this.uploads_completed=d+1,f=s.length-this.uploads_completed):(delete i[e.uploader.storage_path],f=Object.keys(i).length),t.info("[LeatherbackClient] _onUploaderStateChange: Completed ".concat(e.uploader.file.name,", ").concat(f," remaining uploads")),f>0)return;var _="".concat(this.config.leatherback.url,"/attempt/complete/").concat(this.uid),v={upload_session_id:this.id,user_ip:h,browser_info:u.browser_info,bucket:n.Region,clip_id:this.clip_id,title:p.name,folder_id:p.folder_id,current_user:p.target_user_id,origin_user:u.origin_user.id,upload_type:c},g={method:"PUT",headers:{Authorization:"Bearer ".concat(this.jwtToken),"Content-Type":"application/json"},body:JSON.stringify(v)};A(_,g),r(),this._sendBigPictureEvent(Ue.UPLOADER_COMPLETE);break;case l.UPLOADING:var y=a.some((function(e){return e.state===l.UPLOADING}));this.state=y?l.UPLOADING:e.state;break;case l.FAILED:o(e.uploader.error),this._sendBigPictureEvent(Ue.UPLOAD_FAILURE)}}},{key:"_setFileSizeChangeListener",value:function(){var e=this;this.on(u.FILE_SIZE_CHANGED,(function(t){e.fail(t)}))}},{key:"start",value:function(){Ge(Me(t.prototype),"start",this).call(this);var e=this.config.lighthouse,n=this._validate,i=this._create,r=this._start,o=this._onUploaderFail,a=this._getNewToken;this._sendBigPictureEvent(Ue.UPLOAD_FROM_CLIENT),e.getFastestRegion().then(n).then(a).then(i).then(r).catch(o)}},{key:"_sendBigPictureEvent",value:function(e){var t={upload_session_id:this.id,app_id:this.api_app,upload_stage:e,upload_system:"javascript_uploader",file_size:this.file.size,file_type:this.file.type,region:null,clip_id:null,attempt_id:null,upload_id:null,num_files:null,num_endpoints:this.endpoint_count?this.endpoint_count:null,upload_service:"UPLOAD_SERVICE_LEATHERBACK"};je.BigPictureClient.sendEvent(new je.Event("time_to_play_stages",5,t))}},{key:"pause",value:function(){Ge(Me(t.prototype),"pause",this).call(this),this.uploaders.forEach((function(e){e.pause()})),this._update("pause")}},{key:"resume",value:function(){Ge(Me(t.prototype),"resume",this).call(this),this.uploaders.forEach((function(e){e.resume()})),this._update("resume")}},{key:"fail",value:function(e){this.uploaders.forEach((function(t){t.fail(e)}))}},{key:"cancel",value:function(){Ge(Me(t.prototype),"cancel",this).call(this),this.uploaders.forEach((function(e){e.cancel()})),this.uid&&this._update("cancel")}}])&&Fe(n.prototype,i),r&&Fe(n,r),t}(V);function Ve(e){return(Ve="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Be(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function qe(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function We(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e)){var n=[],i=!0,r=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(e){r=!0,o=e}finally{try{i||null==s.return||s.return()}finally{if(r)throw o}}return n}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function Xe(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Je(e,t){return!t||"object"!==Ve(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Ke(e,t,n){return(Ke="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=Ze(e)););return e}(e,t);if(i){var r=Object.getOwnPropertyDescriptor(i,t);return r.get?r.get.call(n):r.value}})(e,t,n||e)}function Ze(e){return(Ze=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Qe(e,t){return(Qe=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var Ye=function(e){function t(e,n,i,r,o,a,s){var l;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),l=Je(this,Ze(t).call(this,e,n,i,r,o)),!e.leatherback)throw new Error("[ApiUploadClient] leatherback data not in the config");if(n===h.CLIP_REPLACE&&!o)throw new Error("[ApiUploadClient] Clip replacement upload must provide a clip_id");return l.site_config=a,l.clip_data=s||null,l.uploaders=[],l.chunk_size=e.default_parallel_chunk_size,l.clip_id=o||null,l.endpoint_count=null,l._setFileSizeChangeListener(),l.vimeo_app=new ce(e,l.logger),l}var n,i,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&Qe(e,t)}(t,e),n=t,(i=[{key:"_bindMethods",value:function(){this._create=this._create.bind(this),this._start=this._start.bind(this),this._update=this._update.bind(this),this._validate=this._validate.bind(this),this._deleteClip=this._deleteClip.bind(this),this._setFileSizeChangeListener=this._setFileSizeChangeListener.bind(this),this._startUploader=this._startUploader.bind(this),this._getNewToken=this._getNewToken.bind(this),this._createAndStartUploaderWithEndpoints=this._createAndStartUploaderWithEndpoints.bind(this),Ke(Ze(t.prototype),"_bindMethods",this).call(this)}},{key:"_validate",value:function(e){var t=We(e,2),n=t[0],i=t[1],r=this.id,o=this.file,a=this.config,s=this.logger,u=this._onValidateReject;return this.fastest_region=n,this.ip=i,this.state=l.VALIDATING,new oe("".concat(a.tomdawg.url,"/probe/").concat(r),s).validateFile(o).catch(u)}},{key:"_create",value:function(){var e=this.config,t=this.file,n=this.logger,i=this.upload_type,r=this.clip_id,o={},a="";i===h.CLIP_REPLACE&&r?(n.info("[ApiUploadClient] _create: Replacing clip by creating new version through API via gcs approach"),o={file_name:t.name.replace(/\.[^.]*$/,""),upload:{approach:"gcs",size:t.size}},a="https://".concat(e.api.url,"/videos/").concat(r,"/versions?fields=upload.gcs,uri,upload.gcs_uid")):(n.info("[ApiUploadClient] _create: Creating file upload through API via gcs approach"),o=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Be(n,!0).forEach((function(t){qe(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Be(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({upload:{approach:"gcs",size:t.size},name:t.name.replace(/\.[^.]*$/,""),folder_id:t.folder_id,current_user:t.target_user_id},this.clip_data),a="https://".concat(e.api.url,"/users/").concat(e.user.id,"/videos?fields=upload.gcs,uri,upload.gcs_uid"));var s={method:"POST",headers:{Authorization:"jwt ".concat(e.api.jwt),Accept:"application/vnd.vimeo.*+json;version=3.4","Content-Type":"application/json"},body:JSON.stringify(o),withCredentials:!0,successCode:201};return A(a,s)}},{key:"_update",value:function(e){var t=this,n=this.config,i=this.upload_type,r=this.uid,o=this.clip_id,a=this.site_config;if(!r){var s=new Error("[ApiUploadClient] _update:  missing upload id");return Promise.reject(s)}var l={clip_id:o,upload_type:i},u="".concat(n.leatherback.url,"/attempt/").concat(e,"/").concat(r),c={method:"PUT",headers:{Authorization:"Bearer ".concat(this.jwtToken),"Content-Type":"application/json"},body:JSON.stringify(l)},p=A(u,c),d={upload_id:this.uid,clip_id:this.clip_id};if(a&&i===h.CLIP_REPLACE){var f="https://".concat(a.api_url,"/videos/").concat(o,"/upload_attempts/").concat(r),_={method:"DELETE",headers:{Authorization:"jwt ".concat(a.site_jwt),"Content-Type":"application/json"},withCredentials:!0,body:JSON.stringify(d),successCode:202};A(f,_).catch((function(e){t.logger.warn("Version deletion for replacement cancellation failed",e)}))}return p}},{key:"_start",value:function(e){var t=e.target,n=t.status,i=t.responseText,r=this.logger;if(201!==n)return Promise.reject("".concat(n));try{var o=JSON.parse(i);this.uploads_completed=0,this.endpoints=o.upload.gcs,this.uid=o.upload.gcs_uid,this.clip_id=o.uri.split("/")[2],this.clip_url=o.uri,this.attempt_id=o.upload.gcs[0].metadata.connections.upload_attempt.uri.replace("/upload/attempt/","");var a=this.endpoints.length;return r.info("[ApiUploadClient] _start: Uploading ".concat(this.file.size," byte file to ").concat(a," endpoints")),r.save(),this.endpoints.forEach(this._createAndStartUploaderWithEndpoints)}catch(e){return Promise.reject()}}},{key:"_onUploaderFail",value:function(e){var n=this.logger,i=this.uploaders;this.state!==l.FAILED&&(n.info("[ApiUploadClient] _onUploaderFail: Failing remaining uploads"),Ke(Ze(t.prototype),"_onUploaderFail",this).call(this,e),this._update("fail"),i.forEach((function(t){t.fail(e)})))}},{key:"_createAndStartUploaderWithEndpoints",value:function(e,t){var n=this.endpoints,i=this.file,r=this.logger,o=this.slice_method,a=this.config,s=this.uid,l=this._onUploaderProgress,c=this._onUploaderStateChange,p=e.upload_link,h=e.start_byte,d=e.end_byte,f=e.metadata.connections.upload_attempt,_=n.length;r.info("[ApiUploadClient] _createAndStartUploaderWithEndpoints for bytes ".concat(h," to ").concat(d," (uploader ").concat(t+1,"/").concat(_,")"));var v=i[o](h,d+1);v.name="".concat(s,"_").concat(t+1,"_").concat(_),v.uid=s;var g=new ie(a,p,v,i.type,r,this.jwtToken);g.storage_path=f,this.uploaders.push(g),g.on(u.PROGRESS,l),g.on(u.STATE_CHANGE,c),g.upload()}},{key:"_getNewToken",value:function(){var e=this,t=this.config,n=this.vimeo_app;try{return Promise.resolve(n.getToken(t.leatherback.token)).then((function(t){return e.jwtToken=t,t}))}catch(e){return Promise.reject(e)}}},{key:"_startUploader",value:function(e,t,n){var i=this.file,r=this.logger,o=this.config,a=this.uploaders,s=this._onUploaderProgress,l=this._onUploaderStateChange,c=new ie(o,e,t,i.type,r);c.storage_path=n,a.push(c),c.on(u.PROGRESS,s),c.on(u.STATE_CHANGE,l),c.upload()}},{key:"_onUploaderProgress",value:function(){var e=this.uploaders;this.bytes_uploaded=e.reduce((function(e,t){return e+t.bytes_uploaded}),0),Ke(Ze(t.prototype),"_onUploaderProgress",this).call(this,{loaded:this.bytes_uploaded})}},{key:"_onUploaderStateChange",value:function(e){var t=this.logger,n=this.signed_urls,i=this._onUploaderComplete,r=this._onUploaderFail,o=this.uploaders,a=this.endpoints,s=this.uploads_completed;switch(e.state){case l.COMPLETED:var u=null;if(void 0!==a?(this.uploads_completed=s+1,u=a.length-this.uploads_completed):(delete n[e.uploader.storage_path],u=Object.keys(n).length),t.info("[ApiUploadClient] _onUploaderStateChange: Completed ".concat(e.uploader.file.name,", ").concat(u," remaining uploads")),u>0)return;i(),this._sendBigPictureEvent(Ue.UPLOADER_COMPLETE);break;case l.UPLOADING:var c=o.some((function(e){return e.state===l.UPLOADING}));this.state=c?l.UPLOADING:e.state;break;case l.FAILED:r(e.uploader.error),this._sendBigPictureEvent(Ue.UPLOAD_FAILURE)}}},{key:"_setFileSizeChangeListener",value:function(){var e=this;this.on(u.FILE_SIZE_CHANGED,(function(t){e.fail(t)}))}},{key:"_deleteClip",value:function(){var e=this.logger,t=this.clip_id,n=this.config;e.info("[ApiUploadClient] _create: Deleting clip via api");var i="https://".concat(n.api.url,"/videos/").concat(t),r={method:"DELETE",headers:{Authorization:"jwt ".concat(n.api.jwt),Accept:"application/vnd.vimeo.*+json;version=3.4","Content-Type":"application/json"},withCredentials:!0,successCode:204};return A(i,r)}},{key:"start",value:function(){Ke(Ze(t.prototype),"start",this).call(this);var e=this.config.lighthouse,n=this._validate,i=this._create,r=this._start,o=this._onUploaderFail,a=this._getNewToken;this._sendBigPictureEvent(Ue.UPLOAD_FROM_CLIENT),e.getFastestRegion().then(n).then(a).then(i).then(r).catch(o)}},{key:"_sendBigPictureEvent",value:function(e){var t={upload_session_id:this.id,app_id:this.api_app,upload_stage:e,upload_system:"javascript_uploader",file_size:this.file.size,file_type:this.file.type,region:null,clip_id:null,attempt_id:null,upload_id:null,num_files:null,num_endpoints:this.endpoint_count?this.endpoint_count:null,upload_service:"UPLOAD_SERVICE_API"};je.BigPictureClient.sendEvent(new je.Event("time_to_play_stages",5,t))}},{key:"pause",value:function(){Ke(Ze(t.prototype),"pause",this).call(this),this.uploaders.forEach((function(e){e.pause()}))}},{key:"resume",value:function(){Ke(Ze(t.prototype),"resume",this).call(this),this.uploaders.forEach((function(e){e.resume()}))}},{key:"fail",value:function(e){this.uploaders.forEach((function(t){t.fail(e)})),this._deleteClip()}},{key:"cancel",value:function(){var e=this.logger;Ke(Ze(t.prototype),"cancel",this).call(this),this.uploaders.forEach((function(e){e.cancel()})),e.info("[ApiUploadClient] _create: Cancelling upload"),this._deleteClip()}}])&&Xe(n.prototype,i),r&&Xe(n,r),t}(V);function $e(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var et=[l.CANCELED,l.COMPLETED,l.FAILED],tt=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.config=t,this._onBeforeWindowUnload=this._onBeforeWindowUnload.bind(this),this._onWindowUnload=this._onWindowUnload.bind(this),this._toggleAbort=this._toggleAbort.bind(this),this.is_set=!1}var t,n,i;return t=e,(n=[{key:"_setWarning",value:function(){this.is_set||(window.addEventListener("beforeunload",this._onBeforeWindowUnload),window.addEventListener("unload",this._onWindowUnload),this.is_set=!0)}},{key:"_removeWarning",value:function(){window.removeEventListener("beforeunload",this._onBeforeWindowUnload),window.removeEventListener("unload",this._onWindowUnload),this.is_set=!1}},{key:"_toggleAbort",value:function(e,t){var n=this.config.service;n===d.UPLOAD_SERVICE_LEATHERBACK||n===d.UPLOAD_SERVICE_API?this._leatherbackToggleAbort(e,t):this._siteToggleAbort(e,t)}},{key:"_siteToggleAbort",value:function(e,t){if(t.attempt_id){var n=this.config.xsrft,i="/upload/_abort?attempt_id=".concat(t.attempt_id,"&upload_type=").concat(t.upload_type);e&&(i+="&revive=true");var r=new FormData;r.append("token",n),t.signature&&r.append("signature",t.signature),window.navigator.sendBeacon(i,r)}}},{key:"_leatherbackToggleAbort",value:function(e,t){if(t.uid){var n=this.config.leatherback,i=n.url,r=n.token,o=e?"".concat(i,"/attempt/revive/").concat(t.uid):"".concat(i,"/attempt/abort/").concat(t.uid),a=new XMLHttpRequest,s=new FormData;a.open("POST",o),s.append("jwt",r),a.send(s)}}},{key:"_onBeforeWindowUnload",value:function(e){var t=this.uploads,n=this._toggleAbort;this._timeout=window.setTimeout((function(){t.forEach((function(e){n(!0,e)}))}),3e3),t.forEach((function(e){n(!1,e)}));var i="WARNING: You are currently uploading ".concat(t.length," video\n            ").concat(1!==t.length?"s":"","! Your uploads will not be completed if you leave this page.");return((e=e||window.event)||window.event).returnValue=i,i}},{key:"_onWindowUnload",value:function(e){var t=this._timeout;clearTimeout(t)}},{key:"uploads",get:function(){return this._uploads},set:function(e){var t=this;this._uploads!==e&&(this._uploads=[],e.forEach((function(e){-1===et.indexOf(e.state)&&t._uploads.push(e)})),this._uploads.length>0?this._setWarning():this._removeWarning())}}])&&$e(t.prototype,n),i&&$e(t,i),e}(),nt={Ip:"127.0.0.1",Regions:[{PingUrl:"https://storage.googleapis.com/vimeo-prod-src-std-us/0.png",Region:"gs-us"}]},it=nt.Regions[0],rt=nt;function ot(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function at(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function st(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var lt=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:window.console;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw new Error("[Lighthouse] url required in first argument");this.url=t,this.logger=n,this.regions=[],this.sorted_regions=[],this._getRegions=this._getRegions.bind(this),this._onRegionsGetSuccess=this._onRegionsGetSuccess.bind(this),this._raceEndpoints=this._raceEndpoints.bind(this),this._sortByRttAndDistance=this._sortByRttAndDistance.bind(this),this._pickWinningEndpoint=this._pickWinningEndpoint.bind(this),this._onRegionsGetFail=this._onRegionsGetFail.bind(this),this._onRaceFail=this._onRaceFail.bind(this),this._getIp=this._getIp.bind(this),this._onIpGetSuccess=this._onIpGetSuccess.bind(this),this._onIpGetFail=this._onIpGetFail.bind(this),this._warn=this._warn.bind(this),this.ip=null,this.fastest_region=null,this.getFastestRegion()}var t,n,i;return t=e,(n=[{key:"_getRegions",value:function(){if(this.regions.length>0)return Promise.resolve(this.regions);var e=this.url;return this._regionsRequest(e)}},{key:"_getIp",value:function(){if(null!==this.ip)return Promise.resolve(this.ip);var e=this.url;return A(e)}},{key:"_onRegionsGetSuccess",value:function(e){var t=e.target,n=t.status,i=t.responseText;if(200!==n)return this.regions=rt.Regions,this.ip=rt.Ip,Promise.resolve(this.regions);var r=null;try{r=JSON.parse(i)}catch(e){return this._warn("[GETREGIONS] ".concat(e)),this.regions=rt.Regions,this.ip=rt.Ip,Promise.resolve(this.regions)}return this.regions=r.Regions,this.ip=r.Ip,Promise.resolve(r.Regions)}},{key:"_onIpGetSuccess",value:function(e){var t=e.target,n=t.status,i=t.responseText;if(200!==n)return Promise.reject("".concat(n,": ").concat(i));var r=null;try{r=JSON.parse(i)}catch(e){return Promise.reject(e)}return this.ip=r.Ip,Promise.resolve(r.Ip)}},{key:"_raceEndpoints",value:function(e){var t=this._pingRequest,n=this._warn,i=[],r=0,o=new Promise((function(o){e.map((function(a,s){var l=window.performance.now();return t(a.PingUrl).then((function(e){var t=window.performance.now()-l,n=200!==e.target.status?0:t;return i.push(function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ot(n,!0).forEach((function(t){at(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ot(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},a,{distance_index:s,rtt:n})),t>=1e3&&o(i),e})).catch((function(e){var t="There was an error pinging ".concat(a.Region,": ").concat(e.message);n("_raceEndpoints: ".concat(t))})).then((function(t){return++r===e.length&&o(i),t}))}))})),a=new Promise((function(e,t){setTimeout((function(){i.length||(n("_raceEndpoints: No successful responses after ".concat(3e3,"ms")),t(U.LIGHTHOUSE_RACE_ERROR)),e(i)}),3e3)}));return Promise.race([a,o])}},{key:"_sortByRttAndDistance",value:function(e){return new Promise((function(t){e.sort((function(e,t){return 100*Math.abs((e.rtt-t.rtt)/e.rtt)<.2?e.distance_index-t.distance_index:e.rtt-t.rtt})),t(e)}))}},{key:"_pickWinningEndpoint",value:function(e){return this.sorted_regions=e,this.fastest_region=e[0],Promise.resolve([this.fastest_region,this.ip])}},{key:"_onRegionsGetFail",value:function(e){return(0,this._warn)("_onRegionsGetFail: ".concat(e.toString())),this.ip=rt.Ip,this.regions=rt.Regions,this.sorted_regions=rt.Regions,this.fastest_region=it,Promise.resolve([this.fastest_region,this.ip])}},{key:"_onIpGetFail",value:function(e){return(0,this._warn)("_onIpGetFail: ".concat(e.toString())),Promise.reject(U.LIGHTHOUSE_LOAD_ERROR)}},{key:"_onRaceFail",value:function(e){var t=this.regions,n=this._warn;return e===U.LIGHTHOUSE_LOAD_ERROR?Promise.reject(e):(n("_onRaceFail: ".concat(e.toString())),t&&t.length>0?(n("_onRaceFail: Resolving with unsorted first region"),Promise.resolve(t[0])):Promise.resolve(this.regions))}},{key:"getFastestRegion",value:function(){var e=this.fastest_region,t=this.ip;if(e)return Promise.resolve([e,t]);var n=this._getRegions,i=this._onRegionsGetSuccess,r=this._pickWinningEndpoint,o=this._onRegionsGetFail;return n().catch(o).then(i).then(r)}},{key:"getIpAddress",value:function(){var e=this.ip;if(e)return Promise.resolve(e);var t=this._getIp,n=this._onIpGetFail,i=this._onIpGetSuccess;return t().catch(n).then(i)}},{key:"_warn",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.logger,i="[Lighthouse] ".concat(e);n.warn(i),t&&T(i)}},{key:"_regionsRequest",value:function(e){return O(e)}},{key:"_pingRequest",value:function(e){return O(e,{method:"HEAD"})}}])&&st(t.prototype,n),i&&st(t,i),e}();function ut(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var ct,pt=function(){function e(t){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),!t)throw new Error("Undefined fresnel index name");"vimeo.com"!==window.location.hostname&&(t+="-dev"),this.endpoint="https://fresnel.vimeocdn.com/add/".concat(t)}var t,n,i;return t=e,(n=[{key:"log",value:function(e){var t=this.endpoint;if(e=JSON.stringify(e),navigator.sendBeacon)return navigator.sendBeacon(t,e);var n=new XMLHttpRequest;return n.open("POST",t,!0),n.setRequestHeader("Content-Type","text/plain;charset=UTF-8"),n.send(e)}}])&&ut(t.prototype,n),i&&ut(t,i),e}();function ht(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var dt=(ht(ct={},"UPLOAD_SERVICE_SITE",3),ht(ct,"UPLOAD_SERVICE_LEATHERBACK",87099),ht(ct,"UPLOAD_SERVICE_API",87099),ct),ft={GCS_RESUMABLE_UPLOADER_APP:3,DROPBOX_APP:20166,BOX_APP:67545,ONEDRIVE_APP:67813,GOOGLE_DRIVE_APP:69025,PARALLEL_UPLOADER_APP:87099};function _t(e){return(_t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function vt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function gt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function yt(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}n.d(t,"SERVICE_APP_IDS",(function(){return dt})),n.d(t,"API_APPS",(function(){return ft})),n.d(t,"ERRORS",(function(){return U})),n.d(t,"ERROR_CODES",(function(){return F})),n.d(t,"EVENTS",(function(){return u})),n.d(t,"SERVICES",(function(){return d})),n.d(t,"STATES",(function(){return l})),n.d(t,"TYPES",(function(){return h}));var bt=[l.CANCELED,l.COMPLETED,l.FAILED],mt=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this.config=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?vt(n,!0).forEach((function(t){gt(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):vt(n).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},i,{},t),this.uploads=new Map,this.site_config=n,this._aborter=new tt(this.config),this.config.lighthouse=new lt(this.config.lighthouse.url),this.fresnel=new pt("upload-stats");var r,o="production"==(r="undefined"!=typeof window?window.location.hostname:"localhost",RegExp(/\bvimeo.com\b/).test(r)?"production":"development")?je.Service.FRESNEL_PROD:je.Service.FRESNEL_DEV;je.BigPictureClient.configure(new je.Configuration(o)),this._setSessionId(),this._setUserId(),this.config.use_core_count&&this._setParallelRequestsCount(),this._onUploadStateChange=this._onUploadStateChange.bind(this),this.clear=this.clear.bind(this)}var t,n,r;return t=e,(n=[{key:"_onUploadStateChange",value:function(e){var t=e.state,n=e.is_resume,i=e.is_restart,r=e.upload;if(!n&&!i){var o=this.uploads;switch(t){case l.COMPLETED:case l.CANCELED:case l.FAILED:this.startQueue();case l.UPLOADING:}this._aborter.uploads=o,this._sendDataToFresnel(t,r)}}},{key:"_setSessionId",value:function(){var e=this;void 0===this._session_id&&setTimeout((function(){void 0===window.__fa_session?void 0===window.vimeo||"object"!==_t(window.vimeo.cur_user)?e._session_id="undefined.".concat(Date.now()):e._session_id="".concat(window.vimeo.cur_user.id,".").concat(Date.now()):e._session_id=window.__fa_session}),0)}},{key:"_setUserId",value:function(){void 0===this._user_id&&(void 0===window.vimeo||"object"!==_t(window.vimeo.cur_user)?this._user_id=0:this._user_id=window.vimeo.cur_user.id)}},{key:"_setParallelRequestsCount",value:function(){var e=window.navigator.hardwareConcurrency||1;this.config.max_parallel_upload_requests=Math.min(e,4)}},{key:"_create",value:function(e,t,n,i,r){var o=this.config,a=this.site_config,s=null;switch(t){case h.CLIP:case h.CLIP_REPLACE:case h.DRM_CLIP:case h.DRM_CLIP_REPLACE:s=87099===n?o.service===d.UPLOAD_SERVICE_API?new Ye(o,t,n,e,i,a,r):new ze(o,t,n,e,i,a):new ye(o,t,n,e,i);break;case h.API_PULL_CLIP:case h.API_PULL_CLIP_REPLACE:s=new Te(o,t,n,e,i);break;default:throw new Error("".concat(t," upload not implemented yet"))}return this.uploads.set(s.id,s),s}},{key:"_start",value:function(e){if(e.state!==l.QUEUED)return e;var t=this.config.max_simultaneous_uploads;return this.summary.in_progress_count>=t?(console.log("Max simultaneous uploads ".concat(t,", leaving in queue")),e):(e.on(u.STATE_CHANGE,this._onUploadStateChange),e.start(),e)}},{key:"_sendDataToFresnel",value:function(e,t){var n=this.config,i=this.fresnel,r=this.uploads,o=this.product,a=this.session_id,s=this.user_id,c=t.file,p=t.upload_type,h=t.api_app,f=0;r.forEach((function(e){e.active&&f++}));var _=t.uid?t.uid:"",v="",g=0;n.service===d.UPLOAD_SERVICE_LEATHERBACK||n.service===d.UPLOAD_SERVICE_API?(t.uploaders&&t.uploaders.length&&(v=t.uploaders[0].bucket),g=t.signed_urls?Object.keys(t.signed_urls).length:g):n.service===d.UPLOAD_SERVICE_SITE&&(v=t.uploader?t.uploader.bucket:v);var y={name:u.STATE_CHANGE,session_id:a,user_id:s,upload_id:_,state:e,bucket:v,concurrent_uploads:f,parallel_requests:g,upload_type:p,product:o,api_app:h,size:c.size,file_type:c.type,location:window?window.location.pathname:"",uploader_version:n.version,service:n.service,user_account_type:n.user.account_type,chunk_number:n.max_parallel_upload_requests};e===l.COMPLETED&&(y.duration=t.duration,y.speed_mbps=t.speed_mbps),e===l.FAILED&&(y.error=t.error.toString()),i.log(y)}},{key:"queue",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:h.CLIP,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,r=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0;return e instanceof FileList&&(e=Array.from(e)),Array.isArray(e)?e.map((function(e){return t._create(e,n,i,r,o)})):this._create(e,n,i,r)}},{key:"startQueue",value:function(){var e=this,t=[];return this.uploads.forEach((function(n){var i=e._start(n);t.push(i)})),t}},{key:"upload",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:h.CLIP,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3,i=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0,o=this.queue(e,t,n,i,r);return this.startQueue(),1===o.length?o[0]:o}},{key:"pauseAll",value:function(){this.uploads.forEach((function(e){e.state===l.UPLOADING&&e.pause()}))}},{key:"resumeAll",value:function(){this.uploads.forEach((function(e){e.state===l.PAUSED&&e.resume()}))}},{key:"cancelAll",value:function(){this.uploads.forEach((function(e){bt.includes(e.state)||e.cancel()}))}},{key:"clearAll",value:function(){this.uploads.forEach(this.clear)}},{key:"clear",value:function(e){bt.includes(e.state)||e.cancel(),this.uploads.delete(e.id),e.state=l.REMOVED}},{key:"version",get:function(){return this.config.version}},{key:"session_id",get:function(){return this._session_id}},{key:"user_id",get:function(){return this._user_id}},{key:"log_to_console",get:function(){return this.config.log_to_console},set:function(e){this.config.log_to_console=!0===e}},{key:"summary",get:function(){var e={total_bytes:0,bytes_uploaded:0,eta:0,active_count:0,complete_count:0,queued_count:0,in_progress_count:0,failed_count:0,canceled_count:0,total_count:0,is_paused:!1,is_canceled:!1,is_complete:!1,has_failures:!1},t=[];return this.uploads.forEach((function(n){if(t.push(n.state),n.state!==l.CANCELED){if(n.state===l.FAILED)return e.failed_count++,void(e.has_failures=!0);e.total_bytes+=n.file.size,e.bytes_uploaded+=n.bytes_uploaded,e.eta+=n.eta||0,e.total_count++,n.state===l.QUEUED&&e.queued_count++,n.state!==l.COMPLETED?e.active_count++:e.complete_count++,e.in_progress_count=e.active_count-e.queued_count}else e.canceled_count++})),t.length>0&&(e.is_paused=t.every((function(e){return!a.hasOwnProperty(e)})),e.is_canceled=t.every((function(e){return e===l.CANCELED})),e.is_complete=t.every((function(e){return e===l.COMPLETED}))),e}},{key:"uploading_clip_ids",get:function(){var e=[];return this.uploads.forEach((function(t){t.clip_id&&t.state!==l.COMPLETE&&e.push(t.clip_id)})),e}},{key:"product",get:function(){return"undefined"!=typeof window&&"vimeo"in window&&vimeo.is_mobile?"mobile":"undefined"!=typeof window&&-1!==window.location.pathname.indexOf("ondemand")?"ondemand":"creator"}}])&&yt(t.prototype,n),r&&yt(t,r),e}();t.default=mt}])}}]);